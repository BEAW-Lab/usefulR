---
title: "usefulR in action: an example to use its functions"
author: "Pablo Capilla-Lasheras"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{usefulR in action: an example to use its functions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
  )

library(usefulR)

```

In this vignette we will:

* calculate urban score using `extract_land_cover.R` (= proportion of impervious surface around a given coordinate)
* calculate amount of artificial light at night using `extract_alan.R` from a VIIRS dataset
* run a simulated model to investigate whether urbanisation score and alan drives variation in a trait
* generate a publication-ready table using `table_results.R`

## Installation
To install the package:
```{r include = T, eval = F}
# install.packages("pak") # install pak if not previously installed
pak::pkg_install("BEAW-Lab/usefulR") # or
devtools::install_github("BEAW-Lab/usefulR", build_vignettes = TRUE, force = TRUE)
```

## Simulate data
First, we simulate a set of coordinates within (roughly) the Iberian Peninsula. We also generate values for 
a predictor variable.
```{r data simulation, include = T}
set.seed(7)
coor <- data.frame(lon = runif(n = 50, min = -6, max = -3),
                   lat = runif(n = 50, min = 39, max = 42),
                   x_var1 = rnorm(n = 50, mean = 0, sd = 5)) # this variable is made up, just a dummy to run a model later
head(coor)
```

## Calculate urban score from land cover data
Using the set of 50 coordinates that we have generated above, we now calculate an urban scores using the `extract_land_cover`
function within `usefulR`. Before going ahead with the calculation, please, keep in mind that this function calculates
(actually) the proportion of impervious surface within a chosen buffer around a set of coordinates, and it 
uses [ESA WorldCover 2021 data](https://worldcover2021.esa.int/). 

The function can be applied to one set of coordinates (bundled in a data frame):
```{r urban score single pair of coordenates, include = T}
# we first download a raster to run the example below. download_ESAWC21_raster_vignette() downloads an example raster that is then stored locally
vignette_dir <- tempdir()

# download file INTO THIS directory
download_ESAWC21_raster_vignette(
  local_dir = vignette_dir,
  file_name = "LC_raster_example.tif",
  force = TRUE
)

# Build the final path
path_to_raster <- file.path(vignette_dir, "LC_raster_example.tif")

extract_land_cover(coords = data.frame(lon = -4.5, lat = 41.00), # (longitude, latitude) the order is important
                   raster_path = path_to_raster,  # if the vignette is built. Name of the downloaded file
                   radius_m = 1500,        # buffer radius in meters
                   cat_vals = c(50))       # categorical value for the land cover of interest. '50' for impervious surface in the ESA WorldCover dataset.

```

and, it can also be applied to a set of multiple pairs of coordinates. In the code below, we calculate the proportion of impervious surface for the data set we simulated above:
```{r urban score, include = T}
data_land_cover <- extract_land_cover(coords = coor %>% select(lon, lat), 
                                      raster_path = path_to_raster,
                                      radius_m = 1500, 
                                      cat_vals = c(50))
head(data_land_cover)
```
You can now then merge the calculation of percent of impervious surface into the initial dataset:
```{r, include = T}
data00 <- left_join(x = coor, 
                  y = data_land_cover, 
                  by = c('lon', 'lat'))

head(data00)
```

For this tutorial, we have only used a small raster that only covers part of the Iberian Peninsula. To use the complete raster, I have written a helper function that allows you to download a complete raster for analysis. Before running `extract_land_cover`, you just need to download this file once and save it in your computer (~700Mb):
```{r, include = T, eval = FALSE}
download_ESAWC21_raster (local_dir = 'directory/to/save/raster',  # adjust to your choice
                                    file_name = "LC_raster.tif",  # adjust to your choice
                                    force = FALSE)
```

Once the file is downloaded and saved, you can use it to run `extract_land_cover`:
```{r, include = T, eval = FALSE}
raster_esa <- rast('./path/to/directory/where/raster/is/saved')
plot(raster_esa) # plot the raster to double check you approximately have the geographical coverage you need

extract_land_cover(coords = coor %>% select(lon, lat), 
                   raster_path = './path/to/directory/where/raster/is/saved',
                   radius_m = 1500, 
                   cat_vals = c(50))

# once extract_land_cover runs, you can adjust the code above to merge its results to your datasest
```

## Calculate artificial light at night
With the same philosophy than the function above to calculate % of impervious surface, the function `extract_alan` allows you to calculate the amount of 
artificial light at night around a given location. First, also following the rationale presented above, you can download a VIIRS dataset of Europe (annual average) to use as input data in the calculation: 
```{r, include = T, eval = TRUE}
# temporal dir to store raster (for the purpose of building the vignette. Change 'local_dir' in download_viirs_raster() to 
# store the file wherever you like. You only need to download the file once)
vignette_dir <- tempdir()

# do this step only once and keep the data saved in your computer
download_viirs_raster(local_dir = vignette_dir,      # put the directory where you want to save the file
                            file_name = "VIIRS_Europe.tif",# adjust to the name you want to give to the file
                            force = FALSE) 

# build the final path (for vignette purposes. You can simple specify the path to your local file in extract_alan())
path_to_raster_viirs <- file.path(vignette_dir, "VIIRS_Europe.tif")
```

Now, we can use the downloaded data to calculate amount of artificial light at night using `extract_alan`. Keep in mind 
that the units of the calculation will be those in which the input raster works.
```{r, include = T, eval = TRUE}
data_alan <- extract_alan(coords = coor %>% select(lon, lat), 
             raster_path = path_to_raster_viirs,
             radius_m = 1500)

head(data_alan)
```
You can now then merge the calculation of ALAN to the dataset for analys:
```{r, include = T}
data <- left_join(x = data00, 
                  y = data_alan %>% select(lon, lat, alan, alan_log), 
                  by = c('lon', 'lat'))

head(data)

```

## Analyse the data and produce publication-ready tables
Before we run a model and show how to generate publication-ready tables, we simulate a response variable that is explained by percentage of impervious surface (but not 'x_var1' or 'alan'. We simulate a 
relationship between percentage of impervious and the simulated response variable with slope 3.5. This is just to generate a dataset that we can analyse and generate a table of results but the results are meaningless. The purpose of this exercise is to show how to produce a publication-ready table. The idea is to use the function below (`table_results` with your own models to generate tables that look good and can be pasted to reports and manuscripts).
```{r simulate response, include = T}
set.seed(8)
data$response <- 3.5 * data$percent_impervious + rnorm(n = nrow(data), mean = 0, sd = 15)
```

Now we run the model to explain variation in the response variable including `percent_impervious` and `x_var1` as fixed effects.
```{r model, include = T}
model <- lm(response ~ percent_impervious + alan + x_var1, data = data)
summary(model)
```

Once we have the model, we can produce a table of results with `table_results`:
```{r table of results, include = T, eval = T}
table_results(
  label_list = list(
    `(Intercept)` = "Intercept",
    `x_var1` = "x_var1",
    `percent_impervious` = '% of impervious surface',
    `alan` = "Artificial light at night (units)"),        
  model_test = model, 
  test = 'F')
```

The code above renders the table in this vignette. You can also save the table to an R object and save it in your `./tables/` folder within your 
working directory:
```{r save table, include = T, eval = F}
table01 <- table_results(
  label_list = list(
    `(Intercept)` = "Intercept",
    `x_var1` = "x_var1",
    `percent_impervious` = '% of impervious surface'),        
  model_test = model, 
  test = 'F')

gtsave(table01, "./tables/table_01.html")
```



