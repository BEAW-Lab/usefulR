---
title: "usefulR in action: an example to use its functions"
author: "Pablo Capilla-Lasheras"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
  )

```

In this vignette we will:

* calculate urban score using `extract_land_cover.R`
* run a mix model to investigate whether urbanisation score drives variation in a trait
* generate a publication-ready table using `table_results.R`

## Simulate data

First, we simulate a set of coordinates within (roughly) the Iberian Peninsula. We also generate values for 
a predictor variable.
```{r data simulation, include = T}
coor <- data.frame(lon = runif(n = 50, min = -9, max = 0),
                   lat = runif(n = 50, min = 36, max = 43),
                   x_var1 = rnorm(n = 50, mean = 0, sd = 5))
head(coor)
```

## Calculate urban score
Using the set of 50 coordinates that we have generated, we now calculate an urban scores using the `extract_land_cover`\
function within `usefulR`. Before going ahead with the calculation, please, keep in mind that this function calculates
(really) the proportion of impervious surface within a chosen buffer around a set of coordenates, and it 
uses [ESA WorldCover 2021 data](https://worldcover2021.esa.int/). 

The function can be applied to one set of coordinates (bundled in a data frame):
```{r urban score single pair of coordenates, include = T}
extract_land_cover(coords = data.frame(lon = -3.50, lat = 42.00), # (longitude, latitude) the order is important
                    raster_lc,
                   radius_m = 1500,        # buffer radius in meters
                    cat_vals = c(50))       # categorical value for the land cover of interest. '50' for impervious surface in the ESA WorldCover dataset.

```

and, it can also be applied to a set of multiple pairs of coordinates. In the code below, we calculate the proportion of impervious surface for the data set we simulated above:
```{r urban score single , include = T}
data_land_cover <- extract_land_cover(coords = coor %>% select(lon, lat), 
                                      raster_lc,
                                      radius_m = 1500, 
                                      cat_vals = c(50))
head(data_land_cover)

```
You can now then merge the calculation of percent of impervious surface into the initial dataset:
```{r, include = T}
data <- left_join(x = coor, 
                  y = data_land_cover, 
                  by = c('lon', 'lat'))

head(data)
```

## Analyse the data and producing publication-ready tables

Before we run a model and show how to generate publication-ready tables, we simulate a response variable that is explained by percentage of impervious surface. We simulate a 
relationship between percentage of impervious and the simulated response variable with slope 3.5.
```{r simulate response, include = T}
data$response <- 3.5 * data$percent_impervious + rnorm(n = nrow(data), mean = 0, sd = 5)

```

Now we run the model to explain variation in the response variable including `percent_impervious` and `x_var1` as fixed effects.
```{r model, include = T}
model <- lm(response ~ percent_impervious + x_var1, data = data)
summary(model)
```

Once we have the model, we can produce a table of results with `table_results`:
```{r table of results, include = T}
table_results(
  label_list = list(
    `(Intercept)` = "Intercept",
    `x_var1` = "x_var1",
    `percent_impervious` = '% of impervious surface'),        
  model_test = model, 
  test = 'F')
```

The code above renders the table in this vignette. You can also save the table to an R object and save it in your `./tables/` folder within your 
working directory:
```{r save table, include = T, eval = F}
table01<- table_results(
  label_list = list(
    `(Intercept)` = "Intercept",
    `x_var1` = "x_var1",
    `percent_impervious` = '% of impervious surface'),        
  model_test = model, 
  test = 'F')

gtsave(table01, "./tables/table_01.html")
```



